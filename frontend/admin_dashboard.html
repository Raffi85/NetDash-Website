<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetDash - Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3a56e4;
            --secondary-color: #6c757d;
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .admin-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }

        .sidebar {
            background-color: var(--primary-color);
            color: white;
            padding: 2rem 0;
        }

        .sidebar-logo {
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.8rem;
            font-weight: bold;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            padding: 1rem 2rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .sidebar-menu li:hover, .sidebar-menu li.active {
            background-color: rgba(255,255,255,0.1);
        }

        .sidebar-menu li a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
        }

        .sidebar-menu li i {
            margin-right: 1rem;
        }

        .main-content {
            padding: 2rem;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .analytics-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .analytics-icon {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .table-container {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 0.75rem;
            text-align: left;
        }

        .user-search {
            display: flex;
            margin-bottom: 1.5rem;
        }

        .user-search input {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .user-search button {
            padding: 0.5rem 1rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            margin-left: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-view {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .btn-suspend {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-logo">NetDash Admin</div>
            <ul class="sidebar-menu">
                <li class="active">
                    <a href="#dashboard"><i class="fas fa-home"></i> Dashboard</a>
                </li>
                <li>
                    <a href="#users"><i class="fas fa-users"></i> User Management</a>
                </li>
                <li>
                    <a href="#plans"><i class="fas fa-clipboard-list"></i> Subscription Plans</a>
                </li>
                <li>
                    <a href="#purchases"><i class="fas fa-credit-card"></i> Purchase Management</a>
                </li>
                <li>
                    <a href="#reviews"><i class="fas fa-comment-dots"></i> Reviews</a>
                </li>
                <li>
                    <a href="#contacts"><i class="fas fa-envelope"></i> Contact Messages</a>
                </li>
                <li>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="dashboard-header">
                <h1>Admin Dashboard</h1>
                <div id="user-info"></div>
            </div>

            <!-- Analytics Section -->
            <div class="analytics-grid" id="dashboard-analytics">
                <!-- Analytics cards will be dynamically populated -->
                 // In the loadDashboardData function, modify the analytics card rendering:
fetch('/api/analytics')
    .then(response => response.json())
    .then(analytics => {
        const analyticsContainer = document.getElementById('dashboard-analytics');
        analyticsContainer.innerHTML = `
            <div class="analytics-card">
                <div class="analytics-icon"><i class="fas fa-users"></i></div>
                <h3>Total Users</h3>
                <p>${analytics.total_users}</p>
            </div>
            <div class="analytics-card">
                <div class="analytics-icon"><i class="fas fa-clipboard-list"></i></div>
                <h3>Active Subscriptions</h3>
                <p>${analytics.active_subscriptions}</p>
                <small>${analytics.completed_subscriptions} active, ${analytics.pending_subscriptions} pending</small>
            </div>
            <div class="analytics-card">
                <div class="analytics-icon"><i class="fas fa-comment-dots"></i></div>
                <h3>Total Reviews</h3>
                <p>${analytics.total_reviews}</p>
            </div>
            <div class="analytics-card">
                <div class="analytics-icon"><i class="fas fa-envelope"></i></div>
                <h3>Pending Contacts</h3>
                <p>${analytics.pending_contacts}</p>
            </div>
        `;
    });

            </div>

            <!-- User Management Section -->
            <div class="card" id="users-section" style="display: none;">
                <h2>User Management</h2>
                <div class="user-search">
                    <input type="text" id="user-search-input" placeholder="Search users...">
                    <button onclick="searchUsers()">Search</button>
                </div>
                <div class="table-container">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Subscription Plans Section -->
            <div class="card" id="plans-section" style="display: none;">
                <h2>Subscription Plans</h2>
                <div class="table-container">
                    <table id="plans-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Features</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="plans-table-body">
                            <!-- Plans will be dynamically populated -->
                        </tbody>
                    </table>
                    <button onclick="showCreatePlanModal()">Create New Plan</button>
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="card" id="reviews-section" style="display: none;">
                <h2>Customer Reviews</h2>
                <div class="table-container">
                    <table id="reviews-table">
                        <thead>
                            <tr>
                                <th>Reviewer</th>
                                <th>Rating</th>
                                <th>Comment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="reviews-table-body">
                            <!-- Reviews will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Contact Messages Section -->
            <div class="card" id="contacts-section" style="display: none;">
                <h2>Contact Messages</h2>
                <div class="table-container">
                    <table id="contacts-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="contacts-table-body">
                            <!-- Contact messages will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals will be added dynamically via JavaScript -->

    <script>
        // Global state
        let currentUser = null;

        // Authentication and Authorization
        function checkAdminAccess() {
            fetch('/api/profile')
                .then(response => {
                    if (!response.ok) {
                        window.location.href = '/';
                        throw new Error('Unauthorized');
                    }
                    return response.json();
                })
                .then(user => {
                    if (user.role !== 'platform_admin') {
                        window.location.href = '/';
                        throw new Error('Not an admin');
                    }
                    currentUser = user;
                    document.getElementById('user-info').textContent = `Welcome, ${user.name}`;
                    loadDashboardData();
                })
                .catch(error => {
                    console.error('Access error:', error);
                    window.location.href = '/';
                });
        }

        // Dashboard Data Loading
        function loadDashboardData() {
            // Load analytics
            fetch('/api/analytics')
                .then(response => response.json())
                .then(analytics => {
                    const analyticsContainer = document.getElementById('dashboard-analytics');
                    analyticsContainer.innerHTML = `
                        <div class="analytics-card">
                            <div class="analytics-icon"><i class="fas fa-users"></i></div>
                            <h3>Total Users</h3>
                            <p>${analytics.total_users}</p>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon"><i class="fas fa-clipboard-list"></i></div>
                            <h3>Active Subscriptions</h3>
                            <p>${analytics.active_subscriptions}</p>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon"><i class="fas fa-comment-dots"></i></div>
                            <h3>Total Reviews</h3>
                            <p>${analytics.total_reviews}</p>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon"><i class="fas fa-envelope"></i></div>
                            <h3>Pending Contacts</h3>
                            <p>${analytics.pending_contacts}</p>
                        </div>
                    `;
                });

            // Load users
            loadUsers();
            // Load plans
            loadPlans();
            // Load reviews
            loadReviews();
            // Load contacts
            loadContacts();
        }

        // User Management
        function loadUsers(searchTerm = '') {
            const usersTableBody = document.getElementById('users-table-body');
            
            // Prepare URL with optional search term
            const url = searchTerm 
                ? `/api/users?search=${encodeURIComponent(searchTerm)}`
                : '/api/users';

            fetch(url)
                .then(response => response.json())
                .then(users => {
                    usersTableBody.innerHTML = users.map(user => `
                        <tr>
                            <td>${user.id}</td>
                            <td>${user.name || `${user.first_name} ${user.last_name}`.trim()}</td>
                            <td>${user.email}</td>
                            <td>${user.role}</td>
                            <td>${user.is_suspended ? 'Suspended' : 'Active'}</td>
                            <td class="action-buttons">
                                <button class="btn-view" onclick="viewUserDetails(${user.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                ${user.is_suspended 
                                    ? `<button class="btn-view" onclick="unsuspendUser(${user.id})">
                                        <i class="fas fa-check-circle"></i> Unsuspend
                                    </button>`
                                    : `<button class="btn-suspend" onclick="suspendUser(${user.id})">
                                        <i class="fas fa-ban"></i> Suspend
                                    </button>`
                                }
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    usersTableBody.innerHTML = `
                        <tr>
                            <td colspan="6">Error loading users. ${error.message}</td>
                        </tr>
                    `;
                });
        }

        function searchUsers() {
            const searchInput = document.getElementById('user-search-input');
            loadUsers(searchInput.value);
        }

        function viewUserDetails(userId) {
            fetch(`/api/users/${userId}`)
                .then(response => response.json())
                .then(user => {
                    // Create a modal to show user details
                    const modalHtml = `
                        <div id="user-details-modal" class="modal">
                            <div class="modal-content">
                                <span class="close-modal" onclick="closeModal('user-details-modal')">&times;</span>
                                <h2>User Details</h2>
                                <div class="user-details">
                                    <p><strong>ID:</strong> ${user.id}</p>
                                    <p><strong>Name:</strong> ${user.name || `${user.first_name} ${user.last_name}`.trim()}</p>
                                    <p><strong>Email:</strong> ${user.email}</p>
                                    <p><strong>Role:</strong> ${user.role}</p>
                                    <p><strong>Status:</strong> ${user.is_suspended ? 'Suspended' : 'Active'}</p>
                                    <p><strong>Created At:</strong> ${new Date(user.created_at).toLocaleString()}</p>
                                    <p><strong>Current Plan:</strong> ${user.plan_name || 'No active plan'}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Add modal to body and show it
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    document.getElementById('user-details-modal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching user details:', error);
                    alert(`Failed to fetch user details: ${error.message}`);
                });
        }

        function suspendUser(userId) {
            if (!confirm('Are you sure you want to suspend this user?')) return;

            fetch(`/api/users/${userId}/suspend`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User suspended successfully');
                        loadUsers(); // Refresh user list
                    } else {
                        alert(`Failed to suspend user: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error suspending user:', error);
                    alert(`Failed to suspend user: ${error.message}`);
                });
        }

        function unsuspendUser(userId) {
            if (!confirm('Are you sure you want to unsuspend this user?')) return;

            fetch(`/api/users/${userId}/unsuspend`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('User unsuspended successfully');
                        loadUsers(); // Refresh user list
                    } else {
                        alert(`Failed to unsuspend user: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error unsuspending user:', error);
                    alert(`Failed to unsuspend user: ${error.message}`);
                });
        }

        // Plans Management
        function loadPlans() {
            const plansTableBody = document.getElementById('plans-table-body');

            fetch('/api/plans')
                .then(response => response.json())
                .then(plans => {
                    plansTableBody.innerHTML = plans.map(plan => `
                        <tr>
                            <td>${plan.name}</td>
                            <td>${plan.price}</td>
                            <td>${Array.isArray(plan.features) 
                                ? plan.features.join(', ') 
                                : (typeof plan.features === 'string' 
                                    ? plan.features 
                                    : 'No features')
                            }</td>
                            <td class="action-buttons">
                                <button class="btn-view" onclick="editPlan(${plan.id})">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading plans:', error);
                    plansTableBody.innerHTML = `
                        <tr>
                            <td colspan="4">Error loading plans. ${error.message}</td>
                        </tr>
                    `;
                });
        }

        function showCreatePlanModal() {
            const modalHtml = `
                <div id="create-plan-modal" class="modal">
                    <div class="modal-content">
                        <span class="close-modal" onclick="closeModal('create-plan-modal')">&times;</span>
                        <h2>Create New Subscription Plan</h2>
                        <form id="create-plan-form">
                            <label>Plan Name:</label>
                            <input type="text" id="plan-name" required>
                            
                            <label>Price:</label>
                            <input type="number" id="plan-price" step="0.01" required>
                            
                            <label>Features (comma-separated):</label>
                            <textarea id="plan-features" required></textarea>
                            
                            <button type="submit">Create Plan</button>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('create-plan-modal').style.display = 'block';
            
            document.getElementById('create-plan-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const planData = {
                    name: document.getElementById('plan-name').value,
                    price: document.getElementById('plan-price').value,
                    features: document.getElementById('plan-features').value.split(',').map(f => f.trim())
                };
                
                fetch('/api/plans', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(planData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Plan created successfully');
                        closeModal('create-plan-modal');
                        loadPlans(); // Refresh plans list
                    } else {
                        alert(`Failed to create plan: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('Error creating plan:', error);
                    alert(`Failed to create plan: ${error.message}`);
                });
            });
        }

        function editPlan(planId) {
            // Implement plan editing functionality
            alert(`Edit plan ${planId} - To be implemented`);
        }

        // Reviews Management
        function loadReviews() {
            const reviewsTableBody = document.getElementById('reviews-table-body');

            fetch('/api/reviews')
                .then(response => response.json())
                .then(reviews => {
                    reviewsTableBody.innerHTML = reviews.map(review => `
                        <tr>
                            <td>${review.name}</td>
                            <td>${review.rating}/5</td>
                            <td>${review.comment}</td>
                            <td class="action-buttons">
                                <button class="btn-view" onclick="approveReview(${review.id})">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn-suspend" onclick="deleteReview(${review.id})">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading reviews:', error);
                    reviewsTableBody.innerHTML = `
                        <tr>
                            <td colspan="4">Error loading reviews. ${error.message}</td>
                        </tr>
                    `;
                });
        }

        function approveReview(reviewId) {
            // Implement review approval logic
            alert(`Approve review ${reviewId} - To be implemented`);
        }

        function deleteReview(reviewId) {
            // Implement review deletion logic
            alert(`Delete review ${reviewId} - To be implemented`);
        }

        // Contact Management
        function loadContacts() {
            const contactsTableBody = document.getElementById('contacts-table-body');

            fetch('/api/contacts')
                .then(response => response.json())
                .then(contacts => {
                    contactsTableBody.innerHTML = contacts.map(contact => `
                        <tr>
                            <td>${contact.name}</td>
                            <td>${contact.email}</td>
                            <td>${contact.message}</td>
                            <td>${new Date(contact.created_at).toLocaleString()}</td>
                            <td>
                                <span class="badge ${contact.status === 'new' ? 'badge-warning' : 'badge-success'}">
                                    ${contact.status}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading contacts:', error);
                    contactsTableBody.innerHTML = `
                        <tr>
                            <td colspan="5">Error loading contacts. ${error.message}</td>
                        </tr>
                    `;
                });
        }

        // Modal and Navigation Utilities
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        function logout() {
            fetch('/api/logout', { method: 'POST' })
                .then(() => {
                    window.location.href = '/';
                })
                .catch(error => {
                    console.error('Logout error:', error);
                    alert('Failed to logout. Please try again.');
                });
        }

        // Navigation
        document.querySelectorAll('.sidebar-menu li').forEach(item => {
            item.addEventListener('click', function() {
                // Remove active class from all items
                document.querySelectorAll('.sidebar-menu li').forEach(li => {
                    li.classList.remove('active');
                });
                
                // Add active class to clicked item
                this.classList.add('active');
                
                // Hide all sections
                ['dashboard-analytics', 'users-section', 'plans-section', 'reviews-section', 'contacts-section']
                    .forEach(sectionId => {
                        const section = document.getElementById(sectionId);
                        if (section) {
                            section.style.display = 'none';
                        }
                    });
                
                // Show corresponding section
                const sectionMap = {
                    'Dashboard': 'dashboard-analytics',
                    'User Management': 'users-section',
                    'Subscription Plans': 'plans-section',
                    'Reviews': 'reviews-section',
                    'Contact Messages': 'contacts-section'
                };
                
                const sectionToShow = sectionMap[this.textContent.trim()];
                if (sectionToShow) {
                    const section = document.getElementById(sectionToShow);
                    if (section) {
                        section.style.display = 'block';
                    }
                }
            });
        });

        // Initial load
        document.addEventListener('DOMContentLoaded', checkAdminAccess);

        function loadPurchases() {
    const purchasesTableBody = document.getElementById('purchases-table-body');
    
    fetch('/api/purchases')
        .then(response => response.json())
        .then(purchases => {
            purchasesTableBody.innerHTML = purchases.map(purchase => `
                <tr>
                    <td>${purchase.id}</td>
                    <td>${purchase.user_name}</td>
                    <td>${purchase.email}</td>
                    <td>${purchase.plan_name}</td>
                    <td>$${purchase.amount}</td>
                    <td><span class="badge ${getBadgeClass(purchase.status)}">${purchase.status}</span></td>
                    <td>${new Date(purchase.purchase_date).toLocaleDateString()}</td>
                    <td class="action-buttons">
                        <button class="btn-view" onclick="updatePurchaseStatus(${purchase.id}, 'completed')">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn-suspend" onclick="updatePurchaseStatus(${purchase.id}, 'failed')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </td>
                </tr>
            `).join('');
        })
        .catch(error => {
            console.error('Error loading purchases:', error);
            purchasesTableBody.innerHTML = `
                <tr>
                    <td colspan="8">Error loading purchases. ${error.message}</td>
                </tr>
            `;
        });
}

function getBadgeClass(status) {
    switch(status) {
        case 'completed': return 'badge-success';
        case 'pending': return 'badge-warning';
        case 'failed': return 'badge-danger';
        case 'refunded': return 'badge-secondary';
        default: return 'badge-secondary';
    }
}

// Add this to your admin_dashboard.html file
function updatePurchaseStatus(purchaseId, status) {
    // Show a loading indicator or disable the button
    const approveBtn = document.querySelector(`button[onclick="updatePurchaseStatus(${purchaseId}, 'completed')"]`);
    const rejectBtn = document.querySelector(`button[onclick="updatePurchaseStatus(${purchaseId}, 'failed')"]`);
    
    if (approveBtn) approveBtn.disabled = true;
    if (rejectBtn) rejectBtn.disabled = true;
    
    fetch(`/api/purchases/${purchaseId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: status })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Server responded with status ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            alert('Purchase status updated successfully');
            // Refresh the page to show updated status
            window.location.reload();
        } else {
            alert(`Failed to update status: ${data.message}`);
            // Re-enable buttons
            if (approveBtn) approveBtn.disabled = false;
            if (rejectBtn) rejectBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error updating purchase status:', error);
        alert(`Failed to update status: ${error.message}`);
        // Re-enable buttons
        if (approveBtn) approveBtn.disabled = false;
        if (rejectBtn) rejectBtn.disabled = false;
    });
}

// Email notification management
window.setupEmailNotifications = function() {
    const modalHtml = `
        <div id="email-config-modal" class="modal" style="display: block;">
            <div class="modal-content">
                <span class="close-modal" onclick="document.getElementById('email-config-modal').remove();">&times;</span>
                <h2>Configure Email Notifications</h2>
                <form id="email-config-form">
                    <div class="form-group">
                        <label>SMTP Server:</label>
                        <input type="text" id="smtp-server" value="smtp.gmail.com" required>
                    </div>
                    <div class="form-group">
                        <label>SMTP Port:</label>
                        <input type="number" id="smtp-port" value="587" required>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" id="smtp-username" required>
                    </div>
                    <div class="form-group">
                        <label>Password:</label>
                        <input type="password" id="smtp-password" required>
                        <small style="display: block; margin-top: 5px;">Note: For Gmail, use an <a href="https://myaccount.google.com/apppasswords" target="_blank">App Password</a> if you have 2FA enabled.</small>
                    </div>
                    <button type="submit" style="margin-top: 10px; padding: 8px 15px; background-color: #3a56e4; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Configuration</button>
                </form>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    document.getElementById('email-config-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const config = {
            smtp_server: document.getElementById('smtp-server').value,
            smtp_port: document.getElementById('smtp-port').value,
            smtp_username: document.getElementById('smtp-username').value,
            smtp_password: document.getElementById('smtp-password').value
        };
        
        fetch('/api/email-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Email configuration saved successfully');
                document.getElementById('email-config-modal').remove();
            } else {
                alert(`Failed to save configuration: ${data.message}`);
            }
        })
        .catch(error => {
            console.error('Error saving email config:', error);
            alert(`Failed to save configuration: ${error.message}`);
        });
    });
};

// Add Configure Email button to Reviews section
document.addEventListener('DOMContentLoaded', function() {
    const reviewsSection = document.getElementById('reviews-section');
    if (reviewsSection && !document.querySelector('#email-config-button')) {
        const emailConfigButton = `
            <button id="email-config-button" onclick="setupEmailNotifications()" style="float: right; padding: 8px 15px; background-color: #3a56e4; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-envelope"></i> Configure Email
            </button>
        `;
        reviewsSection.querySelector('h2').insertAdjacentHTML('afterend', emailConfigButton);
    }
});

// Add purchases section to HTML
const purchasesSection = `
    <div class="card" id="purchases-section" style="display: none;">
        <h2>Purchase Management</h2>
        <div class="table-container">
            <table id="purchases-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Email</th>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="purchases-table-body">
                    <!-- Purchases will be dynamically populated -->
                </tbody>
            </table>
        </div>
    </div>
`;

// Insert purchases section after subscription plans
const subscriptionSection = document.getElementById('plans-section');
subscriptionSection.insertAdjacentHTML('afterend', purchasesSection);

// Update the navigation click handler
document.querySelectorAll('.sidebar-menu li').forEach(item => {
    item.addEventListener('click', function() {
        // Remove active class from all items
        document.querySelectorAll('.sidebar-menu li').forEach(li => {
            li.classList.remove('active');
        });
        
        // Add active class to clicked item
        this.classList.add('active');
        
        // Hide all sections
        ['dashboard-analytics', 'users-section', 'plans-section', 'purchases-section', 'reviews-section', 'contacts-section']
            .forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.style.display = 'none';
                }
            });
        
        // Show corresponding section
        const sectionMap = {
            'Dashboard': 'dashboard-analytics',
            'User Management': 'users-section',
            'Subscription Plans': 'plans-section',
            'Purchase Management': 'purchases-section',
            'Reviews': 'reviews-section',
            'Contact Messages': 'contacts-section'
        };
        
        const sectionToShow = sectionMap[this.textContent.trim()];
        if (sectionToShow) {
            const section = document.getElementById(sectionToShow);
            if (section) {
                section.style.display = 'block';
                
                // Load data based on section
                if (sectionToShow === 'purchases-section') {
                    loadPurchases();
                }
            }
        }
    });
});

// Initialize navigation updates
document.addEventListener('DOMContentLoaded', function() {
    updateNavigation();
});


// Fix Purchase Management section visibility
document.addEventListener('DOMContentLoaded', function() {
    // Ensure the purchases section exists in the DOM
    if (!document.getElementById('purchases-section')) {
        // Create the purchases section if it doesn't exist
        const purchasesSection = `
            <div class="card" id="purchases-section" style="display: none;">
                <h2>Purchase Management</h2>
                <div class="table-container">
                    <table id="purchases-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Customer</th>
                                <th>Email</th>
                                <th>Plan</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-table-body">
                            <!-- Purchases will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        // Insert purchases section after the plans section
        const plansSection = document.getElementById('plans-section');
        if (plansSection) {
            plansSection.insertAdjacentHTML('afterend', purchasesSection);
        } else {
            document.querySelector('.main-content').insertAdjacentHTML('beforeend', purchasesSection);
        }
    }
    
    // Fix the navigation click handler
    document.querySelector('.sidebar-menu li:nth-child(4) a').addEventListener('click', function(e) {
        e.preventDefault();
        
        // Update active class
        document.querySelectorAll('.sidebar-menu li').forEach(li => {
            li.classList.remove('active');
        });
        this.parentElement.classList.add('active');
        
        // Hide all sections
        document.querySelectorAll('.card, #dashboard-analytics').forEach(section => {
            section.style.display = 'none';
        });
        
        // Show purchases section
        const purchasesSection = document.getElementById('purchases-section');
        if (purchasesSection) {
            purchasesSection.style.display = 'block';
            
            // Load purchases data
            fetch('/api/purchases')
                .then(response => response.json())
                .then(purchases => {
                    const purchasesTableBody = document.getElementById('purchases-table-body');
                    if (purchases.length === 0) {
                        purchasesTableBody.innerHTML = '<tr><td colspan="8">No purchases found</td></tr>';
                        return;
                    }
                    
                    purchasesTableBody.innerHTML = purchases.map(purchase => `
                        <tr>
                            <td>${purchase.id || '-'}</td>
                            <td>${purchase.user_name || '-'}</td>
                            <td>${purchase.email || '-'}</td>
                            <td>${purchase.plan_name || '-'}</td>
                            <td>$${purchase.amount || '0.00'}</td>
                            <td><span class="badge ${
                                purchase.status === 'completed' ? 'badge-success' : 
                                purchase.status === 'pending' ? 'badge-warning' :
                                purchase.status === 'failed' ? 'badge-danger' : 'badge-secondary'
                            }">${purchase.status || 'unknown'}</span></td>
                            <td>${purchase.purchase_date ? new Date(purchase.purchase_date).toLocaleDateString() : '-'}</td>
                            <td class="action-buttons">
                                <button class="btn-view" onclick="updatePurchaseStatus(${purchase.id}, 'completed')">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn-suspend" onclick="updatePurchaseStatus(${purchase.id}, 'failed')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </td>
                        </tr>
                    `).join('');
                })
                .catch(error => {
                    console.error('Error loading purchases:', error);
                    document.getElementById('purchases-table-body').innerHTML = `
                        <tr>
                            <td colspan="8">Error loading purchases: ${error.message}</td>
                        </tr>
                    `;
                });
        }
    });
    
    // Fix update purchase status function if it doesn't exist
    if (typeof updatePurchaseStatus !== 'function') {
        window.updatePurchaseStatus = function(purchaseId, status) {
            fetch(`/api/purchases/${purchaseId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: status })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Purchase status updated successfully');
                    // Reload the purchases
                    document.querySelector('.sidebar-menu li:nth-child(4) a').click();
                } else {
                    alert(`Failed to update status: ${data.message}`);
                }
            })
            .catch(error => {
                console.error('Error updating purchase status:', error);
                alert(`Failed to update status: ${error.message}`);
            });
        };
    }
});
</script>





    </script>

    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: black;
        }

        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .badge-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .badge-danger {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .badge-secondary {
            background-color: #e9ecef;
            color: #6c757d;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

    </style>
</body>
</html>